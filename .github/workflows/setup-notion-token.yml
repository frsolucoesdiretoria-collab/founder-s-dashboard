name: Setup Notion Token on VPS

on:
  workflow_dispatch:
    description: 'Configurar NOTION_TOKEN na VPS automaticamente'

jobs:
  setup-token:
    name: Configurar NOTION_TOKEN na VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Configure NOTION_TOKEN on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            cd $PROJECT_PATH
            
            echo "üîß Configurando NOTION_TOKEN em: $PROJECT_PATH"
            
            # Backup do .env.local
            if [ -f .env.local ]; then
              BACKUP_FILE=".env.local.backup.$(date +%Y%m%d_%H%M%S)"
              cp .env.local "$BACKUP_FILE"
              echo "‚úÖ Backup criado: $BACKUP_FILE"
            fi
            
            # Garantir que .env.local existe
            if [ ! -f .env.local ]; then
              echo "‚ö†Ô∏è  .env.local n√£o existe, criando..."
              if [ -f env.local.example ]; then
                cp env.local.example .env.local
              else
                touch .env.local
              fi
            fi
            
            # Configurar NOTION_TOKEN usando secret do GitHub
            NOTION_TOKEN_VALUE="${{ secrets.NOTION_TOKEN_VPS }}"
            
            if [ -z "$NOTION_TOKEN_VALUE" ] || [ "$NOTION_TOKEN_VALUE" == "" ]; then
              echo "‚ùå NOTION_TOKEN_VPS secret n√£o est√° configurado no GitHub"
              echo ""
              echo "üìã Para configurar:"
              echo "   1. Acesse: https://github.com/frsolucoesdiretoria-collab/founder-s-dashboard/settings/secrets/actions"
              echo "   2. Clique em 'New repository secret'"
              echo "   3. Nome: NOTION_TOKEN_VPS"
              echo "   4. Valor: seu token do Notion"
              echo "   5. Clique em 'Add secret'"
              exit 1
            fi
            
            # Substituir ou adicionar NOTION_TOKEN
            if grep -q "^NOTION_TOKEN=" .env.local; then
              # Substituir linha existente
              sed -i "s|^NOTION_TOKEN=.*|NOTION_TOKEN=$NOTION_TOKEN_VALUE|" .env.local
              echo "‚úÖ NOTION_TOKEN atualizado no .env.local"
            else
              # Adicionar no in√≠cio do arquivo
              sed -i "1i NOTION_TOKEN=$NOTION_TOKEN_VALUE" .env.local
              echo "‚úÖ NOTION_TOKEN adicionado ao .env.local"
            fi
            
            # Verificar se foi configurado corretamente
            if grep -q "^NOTION_TOKEN=$NOTION_TOKEN_VALUE" .env.local; then
              echo "‚úÖ NOTION_TOKEN configurado com sucesso!"
            else
              echo "‚ùå Erro ao configurar NOTION_TOKEN"
              exit 1
            fi
            
            # Reiniciar PM2 para aplicar mudan√ßas
            echo ""
            echo "üîÑ Reiniciando PM2..."
            if command -v pm2 >/dev/null 2>&1; then
              # Parar processo existente
              pm2 stop founder-dashboard 2>/dev/null || true
              pm2 delete founder-dashboard 2>/dev/null || true
              sleep 2
              
              # Carregar vari√°veis de ambiente
              set -a
              source .env.local 2>/dev/null || true
              set +a
              
              # Iniciar PM2
              cd $PROJECT_PATH
              NODE_ENV=production pm2 start npm --name "founder-dashboard" -- start 2>&1 || {
                echo "‚ö†Ô∏è  Tentando m√©todo alternativo..."
                pm2 start "npm start" --name "founder-dashboard" --update-env 2>&1 || true
              }
              
              pm2 save 2>/dev/null || true
              sleep 5
              
              # Verificar se iniciou
              if pm2 list | grep -q "founder-dashboard.*online"; then
                echo "‚úÖ PM2 reiniciado com sucesso"
              else
                echo "‚ö†Ô∏è  PM2 pode n√£o ter iniciado corretamente"
                pm2 list | grep -i "founder" || true
              fi
            else
              echo "‚ö†Ô∏è  PM2 n√£o est√° instalado"
            fi
            
            echo ""
            echo "‚úÖ Configura√ß√£o conclu√≠da!"

      - name: Verify Configuration
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set +e
            
            PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            cd $PROJECT_PATH
            
            echo "üîç Verificando configura√ß√£o..."
            
            # Verificar se NOTION_TOKEN est√° configurado (sem mostrar o valor)
            if grep -q "^NOTION_TOKEN=" .env.local && ! grep -q "^NOTION_TOKEN=<<<" .env.local && ! grep -q "^NOTION_TOKEN=$" .env.local; then
              TOKEN_LINE=$(grep "^NOTION_TOKEN=" .env.local | head -1)
              TOKEN_PREFIX=$(echo "$TOKEN_LINE" | cut -d'=' -f2 | cut -c1-10)
              echo "‚úÖ NOTION_TOKEN est√° configurado (prefixo: $TOKEN_PREFIX...)"
            else
              echo "‚ùå NOTION_TOKEN n√£o est√° configurado corretamente"
            fi
            
            # Verificar PM2
            sleep 3
            if pm2 list | grep -q "founder-dashboard.*online"; then
              echo "‚úÖ PM2 est√° rodando"
            else
              echo "‚ö†Ô∏è  PM2 n√£o est√° rodando"
            fi
            
            # Testar health
            HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health 2>/dev/null || echo "000")
            if [ "$HEALTH" = "200" ]; then
              echo "‚úÖ Health check OK"
            else
              echo "‚ö†Ô∏è  Health check retornou status $HEALTH"
            fi
            
            echo "‚úÖ Verifica√ß√£o conclu√≠da!"


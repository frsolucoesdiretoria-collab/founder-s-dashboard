name: Fix Notion Connection on VPS

on:
  workflow_dispatch:
    description: 'Corrigir conex√£o com Notion na VPS'
  push:
    branches:
      - staging
    paths:
      - 'scripts/fix-notion-connection-vps.sh'

jobs:
  fix-notion-connection:
    name: Corrigir Conex√£o Notion na VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Notion Connection on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            # Determine project path based on branch
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            else
              PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            fi
            
            echo "üîß Executando corre√ß√£o de conex√£o Notion em: $PROJECT_PATH"
            
            cd $PROJECT_PATH
            
            # Garantir que o script existe e √© execut√°vel
            if [ ! -f "scripts/fix-notion-connection-vps.sh" ]; then
              echo "‚ùå Script n√£o encontrado. Fazendo pull do c√≥digo..."
              git fetch origin
              git reset --hard origin/${{ github.ref_name }}
              git clean -fd
            fi
            
            chmod +x scripts/fix-notion-connection-vps.sh
            
            # Executar script de corre√ß√£o
            echo "üöÄ Executando script de corre√ß√£o..."
            bash scripts/fix-notion-connection-vps.sh
            
            echo "‚úÖ Corre√ß√£o conclu√≠da!"

      - name: Verify Fix
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            # Determine project path
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            else
              PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            fi
            
            cd $PROJECT_PATH
            
            echo "üîç Verificando corre√ß√£o..."
            
            # Verificar se PM2 est√° rodando
            if pm2 list | grep -q "founder-dashboard.*online"; then
              echo "‚úÖ PM2 est√° rodando"
            else
              echo "‚ùå PM2 n√£o est√° rodando"
              exit 1
            fi
            
            # Testar endpoint de health
            sleep 3
            HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health 2>/dev/null || echo "000")
            if [ "$HEALTH" = "200" ]; then
              echo "‚úÖ Health check OK"
            else
              echo "‚ö†Ô∏è  Health check retornou status $HEALTH"
            fi
            
            # Testar endpoint de KPIs
            KPIS_RESPONSE=$(curl -s http://localhost:3001/api/enzo/kpis 2>/dev/null || echo "[]")
            if echo "$KPIS_RESPONSE" | grep -q '"id"'; then
              KPIS_COUNT=$(echo "$KPIS_RESPONSE" | grep -o '"id"' | wc -l)
              echo "‚úÖ Endpoint /api/enzo/kpis retornou $KPIS_COUNT KPI(s)"
            else
              echo "‚ö†Ô∏è  Endpoint /api/enzo/kpis retornou array vazio ou erro"
            fi
            
            echo "‚úÖ Verifica√ß√£o conclu√≠da!"


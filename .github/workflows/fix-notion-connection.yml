name: Fix Notion Connection on VPS

on:
  workflow_dispatch:
    description: 'Corrigir conex√£o com Notion na VPS'
  push:
    branches:
      - staging
    paths:
      - 'scripts/fix-notion-connection-vps.sh'

jobs:
  fix-notion-connection:
    name: Corrigir Conex√£o Notion na VPS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Notion Connection on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            # Determine project path based on branch
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            else
              PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            fi
            
            echo "üîß Executando corre√ß√£o de conex√£o Notion em: $PROJECT_PATH"
            
            cd $PROJECT_PATH
            
            # Garantir que o script existe e √© execut√°vel
            if [ ! -f "scripts/fix-notion-connection-vps.sh" ]; then
              echo "‚ùå Script n√£o encontrado. Fazendo pull do c√≥digo..."
              git fetch origin
              git reset --hard origin/${{ github.ref_name }}
              git clean -fd
            fi
            
            chmod +x scripts/fix-notion-connection-vps.sh
            
            # Configurar NOTION_TOKEN se o secret existir
            NOTION_TOKEN_VALUE="${{ secrets.NOTION_TOKEN_VPS }}"
            if [ -n "$NOTION_TOKEN_VALUE" ] && [ "$NOTION_TOKEN_VALUE" != "" ]; then
              echo "üîë Configurando NOTION_TOKEN do secret do GitHub..."
              
              # Backup
              if [ -f .env.local ]; then
                cp .env.local .env.local.backup.$(date +%Y%m%d_%H%M%S) 2>/dev/null || true
              fi
              
              # Garantir que .env.local existe
              [ -f .env.local ] || touch .env.local
              
              # Substituir ou adicionar NOTION_TOKEN
              if grep -q "^NOTION_TOKEN=" .env.local; then
                sed -i "s|^NOTION_TOKEN=.*|NOTION_TOKEN=$NOTION_TOKEN_VALUE|" .env.local
                echo "‚úÖ NOTION_TOKEN atualizado"
              else
                sed -i "1i NOTION_TOKEN=$NOTION_TOKEN_VALUE" .env.local
                echo "‚úÖ NOTION_TOKEN adicionado"
              fi
            else
              echo "‚ö†Ô∏è  NOTION_TOKEN_VPS secret n√£o configurado, pulando configura√ß√£o de token"
            fi
            
            # Executar script de corre√ß√£o
            echo "üöÄ Executando script de corre√ß√£o..."
            bash scripts/fix-notion-connection-vps.sh
            
            echo "‚úÖ Corre√ß√£o conclu√≠da!"

      - name: Verify Fix
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set +e  # N√£o parar em erros para permitir diagn√≥stico completo
            
            # Determine project path
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            else
              PROJECT_PATH="${{ secrets.VPS_STAGING_PATH || secrets.VPS_PROJECT_PATH }}"
            fi
            
            cd $PROJECT_PATH
            
            echo "üîç Verificando corre√ß√£o..."
            
            # Verificar se PM2 est√° rodando, se n√£o, tentar iniciar
            if pm2 list | grep -q "founder-dashboard.*online"; then
              echo "‚úÖ PM2 est√° rodando"
            else
              echo "‚ö†Ô∏è  PM2 n√£o est√° rodando, tentando iniciar..."
              
              # Tentar iniciar PM2
              if command -v pm2 >/dev/null 2>&1; then
                # Parar processo existente se houver
                pm2 stop founder-dashboard 2>/dev/null || true
                pm2 delete founder-dashboard 2>/dev/null || true
                sleep 2
                
                # Carregar vari√°veis de ambiente
                set -a
                [ -f .env.local ] && source .env.local 2>/dev/null || true
                set +a
                
                # Iniciar PM2
                cd $PROJECT_PATH
                NODE_ENV=production pm2 start npm --name "founder-dashboard" -- start 2>&1 || {
                  echo "‚ö†Ô∏è  Tentando m√©todo alternativo..."
                  pm2 start "npm start" --name "founder-dashboard" --update-env 2>&1 || true
                }
                
                pm2 save 2>/dev/null || true
                sleep 5
                
                # Verificar novamente
                if pm2 list | grep -q "founder-dashboard.*online"; then
                  echo "‚úÖ PM2 iniciado com sucesso"
                else
                  echo "‚ö†Ô∏è  PM2 ainda n√£o est√° rodando ap√≥s tentativa de iniciar"
                  echo "üìã Status do PM2:"
                  pm2 list || true
                  echo "üìã Logs recentes:"
                  pm2 logs founder-dashboard --lines 10 --nostream 2>/dev/null || echo "N√£o foi poss√≠vel ler logs"
                fi
              else
                echo "‚ùå PM2 n√£o est√° instalado"
              fi
            fi
            
            # Testar endpoint de health (aguardar um pouco)
            sleep 3
            HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health 2>/dev/null || echo "000")
            if [ "$HEALTH" = "200" ]; then
              echo "‚úÖ Health check OK"
            else
              echo "‚ö†Ô∏è  Health check retornou status $HEALTH"
              echo "   Isso pode indicar que o servidor ainda est√° iniciando ou h√° um problema"
            fi
            
            # Testar endpoint de KPIs
            KPIS_RESPONSE=$(curl -s http://localhost:3001/api/enzo/kpis 2>/dev/null || echo "[]")
            if echo "$KPIS_RESPONSE" | grep -q '"id"'; then
              KPIS_COUNT=$(echo "$KPIS_RESPONSE" | grep -o '"id"' | wc -l)
              echo "‚úÖ Endpoint /api/enzo/kpis retornou $KPIS_COUNT KPI(s)"
            else
              echo "‚ö†Ô∏è  Endpoint /api/enzo/kpis retornou array vazio ou erro"
              echo "   Resposta: $(echo "$KPIS_RESPONSE" | head -c 200)"
            fi
            
            echo ""
            echo "üìä Resumo da verifica√ß√£o:"
            echo "   - PM2: $(pm2 list | grep -q 'founder-dashboard.*online' && echo '‚úÖ Rodando' || echo '‚ö†Ô∏è  N√£o rodando')"
            echo "   - Health: $([ "$HEALTH" = "200" ] && echo '‚úÖ OK' || echo '‚ö†Ô∏è  Status $HEALTH')"
            echo "   - KPIs: $([ -n "$KPIS_COUNT" ] && echo "‚úÖ $KPIS_COUNT encontrado(s)" || echo '‚ö†Ô∏è  Nenhum encontrado')"
            echo ""
            echo "‚úÖ Verifica√ß√£o conclu√≠da!"


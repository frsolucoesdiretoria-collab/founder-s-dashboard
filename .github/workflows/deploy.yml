name: Deploy to VPS

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Build application
        run: npm run build

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set +e
            
            PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            cd "$PROJECT_PATH" || exit 1
            
            echo "üöÄ DEPLOY AUTOM√ÅTICO - TUDO SER√Å RESOLVIDO AUTOMATICAMENTE"
            echo "=========================================================="
            
            # 1. Pull c√≥digo
            echo ""
            echo "1Ô∏è‚É£  Atualizando c√≥digo..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # 2. Garantir .env.local existe
            echo ""
            echo "2Ô∏è‚É£  Verificando .env.local..."
            if [ ! -f .env.local ]; then
              if [ -f env.local.example ]; then
                cp env.local.example .env.local
                echo "   ‚úÖ Criado a partir do template"
              else
                echo "   ‚ö†Ô∏è  Template n√£o encontrado, continuando..."
              fi
            else
              echo "   ‚úÖ .env.local existe"
            fi
            
            # 3. Instalar depend√™ncias (determin√≠stico)
            echo ""
            echo "3Ô∏è‚É£  Instalando depend√™ncias..."
            echo "Node: $(node -v)"
            echo "NPM: $(npm -v)"
            
            rm -rf node_modules .npm 2>/dev/null || true
            npm cache clean --force 2>/dev/null || true
            
            if [ -f package-lock.json ]; then
              npm ci --include=dev --no-audit --no-fund
            else
              npm install --include=dev --no-audit --no-fund
            fi
            
            # Validar instala√ß√£o
            npm ls react react-dom --depth=0 || true
            ls -la node_modules/.bin | grep vite || true
            
            echo "   ‚úÖ Depend√™ncias instaladas"
            
            # 4. Build
            echo ""
            echo "4Ô∏è‚É£  Fazendo build..."
            npm run build
            
            if [ ! -d "dist" ] || [ -z "$(ls -A dist 2>/dev/null)" ]; then
              echo "   ‚ùå Build n√£o gerou pasta dist!"
              exit 1
            fi
            echo "   ‚úÖ Build conclu√≠do"
            
            # 5. PM2
            echo ""
            echo "5Ô∏è‚É£  Configurando PM2..."
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            # Parar tudo
            pm2 stop founder-dashboard 2>/dev/null || true
            pm2 delete founder-dashboard 2>/dev/null || true
            lsof -ti:3001 | xargs kill -9 2>/dev/null || true
            sleep 3
            
            # 6. Iniciar servidor
            echo ""
            echo "6Ô∏è‚É£  Iniciando servidor..."
            
            # Carregar .env.local
            if [ -f .env.local ]; then
              set -a
              source .env.local 2>/dev/null || true
              set +a
            fi
            
            export NODE_ENV=production
            export PORT=3001
            
            # Iniciar com PM2 (usar APENAS ecosystem.config.cjs)
            if [ -f ecosystem.config.cjs ]; then
              pm2 start ecosystem.config.cjs 2>&1 || {
                echo "   ‚ö†Ô∏è  Falha ao iniciar com ecosystem.config.cjs, tentando m√©todo alternativo..."
                pm2 start npm --name "founder-dashboard" -- start 2>&1
              }
            else
              echo "   ‚ö†Ô∏è  ecosystem.config.cjs n√£o encontrado, usando m√©todo direto"
              pm2 start npm --name "founder-dashboard" -- start 2>&1
            fi
            
            pm2 save
            
            # 7. Aguardar e verificar
            echo ""
            echo "7Ô∏è‚É£  Verificando servidor..."
            sleep 25
            
            # Verificar m√∫ltiplas vezes
            for i in {1..15}; do
              if pm2 list | grep -q "founder-dashboard.*online"; then
                echo "   ‚úÖ Servidor est√° online!"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "   ‚ùå Servidor n√£o iniciou ap√≥s 15 tentativas"
                echo ""
                echo "   üìã Status PM2:"
                pm2 list
                echo ""
                echo "   üìã Logs (√∫ltimas 100 linhas):"
                pm2 logs founder-dashboard --lines 100 --nostream
                exit 1
              fi
              echo "   Tentativa $i/15 - aguardando..."
              sleep 3
            done
            
            # 8. Testar API
            echo ""
            echo "8Ô∏è‚É£  Testando API..."
            for i in {1..10}; do
              if curl -s -f http://localhost:3001/api/health > /dev/null 2>&1; then
                echo "   ‚úÖ API est√° respondendo!"
                curl http://localhost:3001/api/health
                echo ""
                echo ""
                echo "=========================================================="
                echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
                echo "üåê Site dispon√≠vel em: https://frtechltda.com.br"
                echo "=========================================================="
                exit 0
              fi
              if [ $i -eq 10 ]; then
                echo "   ‚ùå API n√£o respondeu ap√≥s 10 tentativas"
                echo ""
                echo "   üìã Status PM2:"
                pm2 list | grep founder-dashboard
                echo ""
                echo "   üìã Logs (√∫ltimas 50 linhas):"
                pm2 logs founder-dashboard --lines 50 --nostream
                echo ""
                echo "   üîç Porta 3001:"
                lsof -i:3001 || echo "   Porta n√£o est√° em uso"
                exit 1
              fi
              echo "   Tentativa $i/10 - aguardando API..."
              sleep 3
            done

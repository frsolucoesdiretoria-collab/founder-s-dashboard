name: Deploy to VPS

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Build application
        run: npm run build

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            cd "$PROJECT_PATH"
            
            echo "ğŸš€ Deploying to production..."
            
            # Pull latest code
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Preserve .env.local if exists, create if not
            if [ ! -f .env.local ]; then
              echo "âš ï¸  .env.local nÃ£o existe - criando bÃ¡sico..."
              if [ -f env.local.example ]; then
                cp env.local.example .env.local
              fi
            else
              echo "âœ… .env.local existe - preservando"
            fi
            
            # Install dependencies - limpar TUDO primeiro
            echo "ğŸ“¦ Installing dependencies..."
            echo "   Limpando completamente node_modules e cache..."
            rm -rf node_modules package-lock.json 2>/dev/null || true
            npm cache clean --force 2>/dev/null || true
            
            echo "   Instalando dependÃªncias (pode demorar)..."
            # Usar npm install em vez de npm ci para evitar problemas com lockfile corrompido
            npm install --include=dev --legacy-peer-deps --no-audit --no-fund || {
              echo "âš ï¸  Primeira tentativa falhou, tentando novamente..."
              rm -rf node_modules 2>/dev/null || true
              npm install --include=dev --legacy-peer-deps --no-audit --no-fund
            }
            
            # Build
            echo "ğŸ”¨ Building..."
            # Verificar se node_modules foi instalado corretamente
            if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
              echo "âŒ node_modules vazio ou nÃ£o existe!"
              exit 1
            fi
            
            NODE_ENV=production npm run build || {
              echo "âš ï¸  Build falhou, tentando novamente..."
              npm run build
            }
            
            # Install PM2 if needed
            if ! command -v pm2 &> /dev/null; then
              npm install -g pm2
            fi
            
            # Stop old process
            echo "ğŸ”„ Restarting server..."
            pm2 stop founder-dashboard 2>/dev/null || true
            pm2 delete founder-dashboard 2>/dev/null || true
            lsof -ti:3001 | xargs kill -9 2>/dev/null || true
            sleep 2
            
            # Use ecosystem.config.js which loads .env.local automatically
            echo "ğŸ“‹ Starting PM2 with ecosystem.config.js..."
            pm2 start ecosystem.config.js || pm2 start npm --name "founder-dashboard" -- start
            pm2 save
            
            # Wait and check
            echo "â³ Waiting for server to start..."
            sleep 20
            
            # Check PM2 status multiple times
            MAX_RETRIES=10
            RETRY=0
            SERVER_ONLINE=false
            
            while [ $RETRY -lt $MAX_RETRIES ]; do
              if pm2 list | grep -q "founder-dashboard.*online"; then
                SERVER_ONLINE=true
                break
              fi
              RETRY=$((RETRY + 1))
              echo "   Tentativa $RETRY/$MAX_RETRIES - aguardando..."
              sleep 3
            done
            
            if [ "$SERVER_ONLINE" = true ]; then
              echo "âœ… Server is online"
              
              # Test API multiple times
              RETRY=0
              API_OK=false
              while [ $RETRY -lt 5 ]; do
                if curl -s -f http://localhost:3001/api/health > /dev/null 2>&1; then
                  API_OK=true
                  break
                fi
                RETRY=$((RETRY + 1))
                echo "   Testando API - tentativa $RETRY/5..."
                sleep 3
              done
              
              if [ "$API_OK" = true ]; then
                echo "âœ… API is responding!"
                curl http://localhost:3001/api/health
                echo ""
              else
                echo "âš ï¸  Server online but API not responding"
                echo "ğŸ“‹ PM2 Status:"
                pm2 list | grep founder-dashboard
                echo ""
                echo "ğŸ“‹ Logs (Ãºltimas 50 linhas):"
                pm2 logs founder-dashboard --lines 50 --nostream
                exit 1
              fi
            else
              echo "âŒ Server failed to start"
              echo "ğŸ“‹ PM2 Status:"
              pm2 list
              echo ""
              echo "ğŸ“‹ Logs (Ãºltimas 100 linhas):"
              pm2 logs founder-dashboard --lines 100 --nostream
              echo ""
              echo "ğŸ” Verificando porta 3001:"
              lsof -i:3001 || echo "   Porta 3001 nÃ£o estÃ¡ em uso"
              exit 1
            fi
            
            echo "âœ… Deployment completed!"

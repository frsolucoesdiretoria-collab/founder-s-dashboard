name: Deploy to VPS

on:
  push:
    branches:
      - staging
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --include=dev

      - name: Build application
        run: npm run build

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            
            PROJECT_PATH="${{ secrets.VPS_PROJECT_PATH }}"
            cd "$PROJECT_PATH"
            
            echo "üöÄ Deploying to production..."
            
            # Pull latest code
            echo "üì• Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Preserve .env.local
            if [ ! -f .env.local ]; then
              echo "‚ö†Ô∏è  .env.local n√£o existe - criando b√°sico..."
              if [ -f env.local.example ]; then
                cp env.local.example .env.local
              fi
            else
              echo "‚úÖ .env.local existe - preservando"
            fi
            
            # Usar script de diagn√≥stico e corre√ß√£o
            if [ -f scripts/diagnose-and-fix.sh ]; then
              echo "üîß Executando script de diagn√≥stico e corre√ß√£o..."
              chmod +x scripts/diagnose-and-fix.sh
              bash scripts/diagnose-and-fix.sh
            else
              echo "‚ö†Ô∏è  Script de diagn√≥stico n√£o encontrado, usando m√©todo manual..."
              
              # Install dependencies
              echo "üì¶ Installing dependencies..."
              rm -rf node_modules package-lock.json 2>/dev/null || true
              npm cache clean --force 2>/dev/null || true
              npm install --include=dev --legacy-peer-deps --no-audit --no-fund || {
                echo "‚ö†Ô∏è  Primeira tentativa falhou, tentando novamente..."
                rm -rf node_modules 2>/dev/null || true
                npm install --include=dev --legacy-peer-deps --no-audit --no-fund
              }
              
              # Build
              echo "üî® Building..."
              if [ ! -d "node_modules" ] || [ -z "$(ls -A node_modules 2>/dev/null)" ]; then
                echo "‚ùå node_modules vazio ou n√£o existe!"
                exit 1
              fi
              
              NODE_ENV=production npm run build || {
                echo "‚ö†Ô∏è  Build falhou, tentando novamente..."
                npm run build
              }
              
              # Install PM2 if needed
              if ! command -v pm2 &> /dev/null; then
                npm install -g pm2
              fi
              
              # Stop old process
              echo "üîÑ Restarting server..."
              pm2 stop founder-dashboard 2>/dev/null || true
              pm2 delete founder-dashboard 2>/dev/null || true
              lsof -ti:3001 | xargs kill -9 2>/dev/null || true
              sleep 2
              
              # Load .env.local and start
              if [ -f .env.local ]; then
                set -a
                source .env.local 2>/dev/null || true
                set +a
              fi
              
              export NODE_ENV=production
              export PORT=3001
              
              # Start PM2
              if [ -f ecosystem.config.js ]; then
                pm2 start ecosystem.config.js || pm2 start npm --name "founder-dashboard" -- start
              else
                pm2 start npm --name "founder-dashboard" -- start
              fi
              pm2 save
              
              # Wait and check
              echo "‚è≥ Waiting for server..."
              sleep 20
              
              MAX_RETRIES=10
              RETRY=0
              SERVER_ONLINE=false
              
              while [ $RETRY -lt $MAX_RETRIES ]; do
                if pm2 list | grep -q "founder-dashboard.*online"; then
                  SERVER_ONLINE=true
                  break
                fi
                RETRY=$((RETRY + 1))
                echo "   Tentativa $RETRY/$MAX_RETRIES..."
                sleep 3
              done
              
              if [ "$SERVER_ONLINE" = true ]; then
                echo "‚úÖ Server is online"
                
                RETRY=0
                API_OK=false
                while [ $RETRY -lt 5 ]; do
                  if curl -s -f http://localhost:3001/api/health > /dev/null 2>&1; then
                    API_OK=true
                    break
                  fi
                  RETRY=$((RETRY + 1))
                  sleep 3
                done
                
                if [ "$API_OK" = true ]; then
                  echo "‚úÖ API is responding!"
                  curl http://localhost:3001/api/health
                else
                  echo "‚ö†Ô∏è  API not responding"
                  pm2 logs founder-dashboard --lines 50 --nostream
                  exit 1
                fi
              else
                echo "‚ùå Server failed to start"
                pm2 logs founder-dashboard --lines 100 --nostream
                exit 1
              fi
            fi
            
            echo "‚úÖ Deployment completed!"

# =============================================================================
# DEPLOY EST√ÅTICO ‚Äî Frontend como site est√°tico
# =============================================================================
# - Build executado SOMENTE no GitHub Actions
# - Deploy envia dist/ via rsync para VPS (/var/www/app)
# - Valida apenas estrutura de arquivos (n√£o conte√∫do)
# - Reinicia PM2 se necess√°rio
# =============================================================================

name: Deploy Static to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    name: Build and Deploy Static
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run build
        run: npm run build

      - name: Validate build output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "::error::dist/index.html not found after build"
            exit 1
          fi
          
          echo "Build OK: $(du -sh dist | cut -f1)"
          echo "‚úÖ Build conclu√≠do com sucesso."

      - name: Setup SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
        run: |
          set -e
          
          if [ -z "$VPS_HOST" ] || [ -z "$VPS_USER" ] || [ -z "$VPS_SSH_KEY" ]; then
            echo "::error::VPS_HOST, VPS_USER and VPS_SSH_KEY are required"
            exit 1
          fi
          
          echo "üîê Configurando SSH..."
          
          # Criar diret√≥rio .ssh
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Salvar chave SSH
          echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Adicionar host ao known_hosts (evita prompt de confirma√ß√£o)
          ssh-keyscan -p ${VPS_PORT} -H ${VPS_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts
          
          # Testar conex√£o SSH
          echo "üß™ Testando conex√£o SSH..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=accept-new \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -p ${VPS_PORT} \
            ${VPS_USER}@${VPS_HOST} \
            "echo '‚úÖ Conex√£o SSH OK'"
          
          echo "‚úÖ SSH configurado com sucesso"

      - name: Deploy dist to VPS (rsync)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
          VPS_STATIC_ROOT: ${{ secrets.VPS_STATIC_ROOT || '/var/www/founder-dashboard/dist' }}
        run: |
          set -e
          
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${VPS_PORT}"
          DEST="${VPS_USER}@${VPS_HOST}:${VPS_STATIC_ROOT}"
          
          echo "üì¶ Criando diret√≥rio destino: ${VPS_STATIC_ROOT}"
          ssh $SSH_OPTS "${VPS_USER}@${VPS_HOST}" "mkdir -p ${VPS_STATIC_ROOT} && chmod 755 ${VPS_STATIC_ROOT}"
          
          echo "üöÄ Sincronizando arquivos..."
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.gitignore' \
            --exclude 'node_modules' \
            -e "ssh $SSH_OPTS" \
            dist/ \
            "${DEST}/"
          
          echo "‚úÖ Arquivos sincronizados para ${DEST}"

      - name: Validate and Restart on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
          VPS_STATIC_ROOT: ${{ secrets.VPS_STATIC_ROOT || '/var/www/founder-dashboard/dist' }}
        run: |
          set -e
          
          SSH_OPTS="-i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new -o UserKnownHostsFile=~/.ssh/known_hosts -p ${VPS_PORT}"
          
          echo "üîç Validando deploy em produ√ß√£o..."
          
          # Validar apenas exist√™ncia de arquivos cr√≠ticos (n√£o conte√∫do)
          if ! ssh $SSH_OPTS "${VPS_USER}@${VPS_HOST}" "test -f ${VPS_STATIC_ROOT}/index.html"; then
            echo "::error::index.html n√£o encontrado em produ√ß√£o"
            exit 1
          fi
          
          echo "‚úÖ Arquivos cr√≠ticos presentes em produ√ß√£o"
          
          echo "üîÑ Verificando PM2..."
          
          # Verificar se PM2 est√° instalado e listar processos
          PM2_LIST=$(ssh $SSH_OPTS "${VPS_USER}@${VPS_HOST}" "pm2 list 2>/dev/null || echo 'PM2_NOT_FOUND'")
          
          if echo "$PM2_LIST" | grep -q "PM2_NOT_FOUND"; then
            echo "‚ö†Ô∏è  PM2 n√£o encontrado. Deploy est√°tico apenas."
          else
            echo "üìã Processos PM2:"
            echo "$PM2_LIST"
            
            # Tentar reiniciar aplica√ß√µes relacionadas ao projeto
            echo "üîÑ Reiniciando aplica√ß√µes relacionadas..."
            ssh $SSH_OPTS "${VPS_USER}@${VPS_HOST}" "
              pm2 list 2>/dev/null | grep -E '(founder|dashboard|app)' | awk '{print \$4}' | while read app; do
                if [ ! -z \"\$app\" ] && [ \"\$app\" != \"name\" ]; then
                  echo \"Reiniciando \$app...\"
                  pm2 restart \"\$app\" || echo \"N√£o foi poss√≠vel reiniciar \$app\"
                fi
              done || echo \"Nenhuma aplica√ß√£o relacionada encontrada\"
            " || echo "‚ö†Ô∏è  N√£o foi poss√≠vel reiniciar aplica√ß√µes PM2"
          fi
          
          echo "‚úÖ Deploy conclu√≠do!"
